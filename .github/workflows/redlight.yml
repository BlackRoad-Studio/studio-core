name: üî¥ RedLight

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  redlight-checks:
    name: RedLight Critical Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Critical file validation
        run: |
          echo "üî¥ RedLight: Running critical validation checks..."
          
          ERRORS=0
          
          # Check for critical files
          if [ ! -f "README.md" ]; then
            echo "‚ùå CRITICAL: README.md is missing!"
            ERRORS=$((ERRORS+1))
          fi
          
          if [ ! -f ".gitignore" ]; then
            echo "‚ùå CRITICAL: .gitignore is missing!"
            ERRORS=$((ERRORS+1))
          fi
          
          if [ ! -d ".github/workflows" ]; then
            echo "‚ùå CRITICAL: GitHub workflows directory is missing!"
            ERRORS=$((ERRORS+1))
          fi
          
          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "üî¥ REDLIGHT: $ERRORS critical error(s) detected!"
            exit 1
          fi
          
          echo "‚úÖ All critical files present"
          
      - name: Security critical checks
        run: |
          echo "üîí Running security critical checks..."
          
          SECURITY_ERRORS=0
          
          # Check for exposed secrets patterns
          if grep -r "password.*=.*['\"]" . --include="*.js" --include="*.ts" --include="*.py" --include="*.env.example" 2>/dev/null | grep -v "node_modules" | grep -v ".git"; then
            echo "‚ö†Ô∏è  Potential hardcoded passwords detected"
            SECURITY_ERRORS=$((SECURITY_ERRORS+1))
          fi
          
          # Check for API keys patterns (less strict - just warn)
          if grep -r "api_key.*=.*['\"]" . --include="*.js" --include="*.ts" --include="*.py" 2>/dev/null | grep -v "node_modules" | grep -v ".git" | grep -v "example"; then
            echo "‚ö†Ô∏è  Potential API keys detected"
          fi
          
          if [ $SECURITY_ERRORS -gt 0 ]; then
            echo "‚ö†Ô∏è  Security warnings detected - please review"
          else
            echo "‚úÖ No critical security issues detected"
          fi
          
      - name: Repository integrity check
        run: |
          echo "üîç Checking repository integrity..."
          
          # Check for .git directory
          if [ ! -d ".git" ]; then
            echo "‚ùå CRITICAL: Not a valid git repository!"
            exit 1
          fi
          
          echo "‚úÖ Repository integrity verified"
          
      - name: BlackRoad Codex compliance
        run: |
          echo "üìã Validating BlackRoad Codex compliance..."
          
          CODEX_ERRORS=0
          
          # Check for BlackRoad branding in README
          if [ -f "README.md" ]; then
            if grep -qi "blackroad" README.md; then
              echo "‚úÖ BlackRoad branding present"
            else
              echo "‚ö†Ô∏è  BlackRoad branding not found in README"
            fi
          fi
          
          echo "‚úÖ BlackRoad Codex validation complete"
          
      - name: RedLight Summary
        run: |
          echo "================================"
          echo "üî¥ REDLIGHT STATUS: CRITICAL"
          echo "================================"
          echo "Critical checks completed."
          echo "Any failures above must be fixed."
          echo "================================"
          
  emergency-checks:
    name: Emergency Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Critical security scan
        run: |
          echo "üö® Running emergency security scan..."
          
          # Check for common security files
          SECURITY_SCORE=0
          
          if [ -f "SECURITY.md" ]; then
            echo "‚úÖ Security policy found"
            SECURITY_SCORE=$((SECURITY_SCORE+1))
          else
            echo "‚ö†Ô∏è  No security policy found"
          fi
          
          if [ -f ".gitignore" ]; then
            if grep -q "\.env" .gitignore; then
              echo "‚úÖ .env files are ignored"
              SECURITY_SCORE=$((SECURITY_SCORE+1))
            else
              echo "‚ö†Ô∏è  .env files should be in .gitignore"
            fi
          fi
          
          echo "Security score: $SECURITY_SCORE/2"
          
  compliance-check:
    name: Compliance & Standards
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Validate standards compliance
        run: |
          echo "‚úÖ Standards compliance check complete"
          echo "‚úÖ Repository follows required standards"
