name: ï¿½ï¿½ Bot â€” PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review_comment:
    types: [created]

permissions:
  pull-requests: write
  contents: read

jobs:
  auto-review:
    name: Agent Code Review
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Get changed files
        id: files
        run: |
          echo "files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | head -20 | tr '\n' ',')" >> $GITHUB_OUTPUT

      - name: Auto-label PR
        uses: actions/github-script@v7
        with:
          script: |
            const files = '${{ steps.files.outputs.files }}'.split(',').filter(Boolean);
            const labels = new Set();
            for (const f of files) {
              if (f.match(/\.(ts|tsx|js|jsx)$/)) labels.add('javascript');
              if (f.match(/\.py$/)) labels.add('python');
              if (f.match(/\.go$/)) labels.add('golang');
              if (f.match(/\.(yml|yaml)$/)) labels.add('ci/cd');
              if (f.match(/^\.github\//)) labels.add('github-actions');
              if (f.match(/test|spec/i)) labels.add('testing');
              if (f.match(/security|auth|vault/i)) labels.add('security');
              if (f.match(/agent|lucidia|alice|octavia|cipher|echo|prism/i)) labels.add('agents');
            }
            if (labels.size > 0) {
              // Create labels that don't exist, then apply
              for (const label of labels) {
                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner, repo: context.repo.repo,
                    name: label, color: 'FF1D6C',
                  });
                } catch {}
              }
              await github.rest.issues.addLabels({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: [...labels],
              });
            }

      - name: Size label
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner, repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });
            const additions = pr.additions + pr.deletions;
            const size = additions < 10 ? 'XS' : additions < 50 ? 'S' : additions < 200 ? 'M' : additions < 500 ? 'L' : 'XL';
            const colors = { XS: '22c55e', S: '84cc16', M: 'eab308', L: 'f97316', XL: 'ef4444' };
            try {
              await github.rest.issues.createLabel({
                owner: context.repo.owner, repo: context.repo.repo,
                name: `size/${size}`, color: colors[size],
              });
            } catch {}
            await github.rest.issues.addLabels({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: [`size/${size}`],
            });

      - name: Welcome first-time contributor
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner, repo: context.repo.repo,
              state: 'all', per_page: 100,
            });
            const author = context.payload.pull_request.user.login;
            const prsByAuthor = pulls.filter(p => p.user.login === author);
            if (prsByAuthor.length === 1) {
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `ðŸ‘‹ Welcome to **${context.repo.repo}**, @${author}! Thanks for your first PR. Our team will review it shortly.\n\n**BlackRoad OS, Inc.** â€” Your AI. Your Hardware. Your Rules. ðŸš€`,
              });
            }
